# Fitness Record 系统架构设计

## 1. 整体架构

### 1.1 架构概述
Fitness Record 采用现代化的Web应用架构，基于Rust + Axum构建高性能的后端服务，前端采用响应式设计确保移动端友好体验。

### 1.2 技术栈
- **后端框架**: Rust + Axum
- **部署平台**: Shuttle
- **数据库**: SQLite (开发) / PostgreSQL (生产)
- **前端**: HTML + CSS + JavaScript (Vanilla)
- **认证**: JWT Token
- **图表**: Chart.js / D3.js

### 1.3 系统架构图
```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   前端 (SPA)    │    │   移动端浏览器   │    │   桌面浏览器    │
└─────────┬───────┘    └─────────┬───────┘    └─────────┬───────┘
          │                      │                      │
          └──────────────────────┼──────────────────────┘
                                 │
                    ┌─────────────┴─────────────┐
                    │       负载均衡/反向代理    │
                    └─────────────┬─────────────┘
                                 │
                    ┌─────────────┴─────────────┐
                    │      Axum Web Server      │
                    │  ┌─────────────────────┐  │
                    │  │   认证中间件        │  │
                    │  └─────────────────────┘  │
                    │  ┌─────────────────────┐  │
                    │  │   业务逻辑层        │  │
                    │  └─────────────────────┘  │
                    │  ┌─────────────────────┐  │
                    │  │   数据访问层        │  │
                    │  └─────────────────────┘  │
                    └─────────────┬─────────────┘
                                 │
                    ┌─────────────┴─────────────┐
                    │        数据库             │
                    │  ┌─────────────────────┐  │
                    │  │     SQLite/PostgreSQL│  │
                    │  └─────────────────────┘  │
                    └───────────────────────────┘
```

## 2. 模块设计

### 2.1 核心模块
```
src/
├── main.rs                 # 应用入口
├── auth/                   # 认证模块
│   ├── mod.rs
│   ├── jwt.rs             # JWT处理
│   ├── middleware.rs       # 认证中间件
│   └── routes.rs          # 认证路由
├── models/                 # 数据模型
│   ├── mod.rs
│   ├── user.rs            # 用户模型
│   ├── training.rs        # 训练模型
│   └── exercise.rs        # 训练项目模型
├── handlers/               # 请求处理器
│   ├── mod.rs
│   ├── auth.rs            # 认证处理器
│   ├── training.rs        # 训练处理器
│   └── analytics.rs       # 数据分析处理器
├── database/               # 数据库模块
│   ├── mod.rs
│   ├── connection.rs      # 数据库连接
│   └── migrations/        # 数据库迁移
├── services/               # 业务逻辑层
│   ├── mod.rs
│   ├── auth_service.rs    # 认证服务
│   ├── training_service.rs # 训练服务
│   └── analytics_service.rs # 分析服务
└── utils/                  # 工具模块
    ├── mod.rs
    ├── error.rs           # 错误处理
    └── response.rs        # 响应格式化
```

### 2.2 模块职责

#### 认证模块 (auth/)
- 用户注册、登录、登出
- JWT token生成和验证
- 密码加密和验证
- 认证中间件

#### 数据模型 (models/)
- 定义数据库表结构
- 数据验证和序列化
- 业务逻辑封装

#### 请求处理器 (handlers/)
- HTTP请求处理
- 参数验证
- 响应格式化
- 错误处理

#### 业务逻辑层 (services/)
- 核心业务逻辑
- 数据处理和计算
- 外部服务集成

#### 数据库模块 (database/)
- 数据库连接管理
- 迁移脚本
- 查询优化

## 3. 数据流设计

### 3.1 请求处理流程
1. **请求接收**: Axum接收HTTP请求
2. **中间件处理**: 认证、日志、CORS等中间件
3. **路由分发**: 根据URL分发到对应处理器
4. **参数验证**: 验证请求参数
5. **业务处理**: 调用业务逻辑层
6. **数据访问**: 访问数据库
7. **响应返回**: 格式化响应并返回

### 3.2 认证流程
1. 用户提交登录信息
2. 验证用户名和密码
3. 生成JWT token
4. 返回token给客户端
5. 后续请求携带token
6. 中间件验证token有效性

## 4. 安全设计

### 4.1 认证安全
- 密码使用bcrypt加密
- JWT token有过期时间
- 支持token刷新机制
- 防止暴力破解攻击

### 4.2 数据安全
- 所有用户输入进行验证
- 防止SQL注入攻击
- 防止XSS攻击
- 敏感数据加密存储

### 4.3 API安全
- 使用HTTPS传输
- 实现API限流
- 请求日志记录
- 错误信息不暴露敏感数据

## 5. 性能优化

### 5.1 数据库优化
- 合理设计索引
- 使用连接池
- 查询优化
- 数据分页

### 5.2 缓存策略
- 用户会话缓存
- 静态资源缓存
- 数据库查询缓存
- CDN加速

### 5.3 并发处理
- 异步处理请求
- 连接池管理
- 负载均衡
- 错误重试机制

## 6. 部署架构

### 6.1 Shuttle部署
- 使用Shuttle平台自动部署
- 环境变量配置
- 数据库自动迁移
- 健康检查机制

### 6.2 监控和日志
- 应用性能监控
- 错误日志收集
- 用户行为分析
- 系统健康检查

## 7. 扩展性设计

### 7.1 水平扩展
- 无状态设计
- 负载均衡支持
- 数据库读写分离
- 缓存集群

### 7.2 功能扩展
- 模块化设计
- 插件化架构
- API版本控制
- 微服务拆分准备

## 8. 开发环境

### 8.1 本地开发
- 使用SQLite数据库
- 热重载支持
- 调试工具集成
- 测试环境配置

### 8.2 测试策略
- 单元测试覆盖
- 集成测试
- API测试
- 性能测试 